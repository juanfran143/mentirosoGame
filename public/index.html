<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mentiroso (1 comodÃ­n)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 680px; margin: 16px auto; padding: 0 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .card { border: 1px solid #e5e5e5; border-radius: 16px; padding: 14px; margin: 12px 0; }
    .muted { color: #555; font-size: .9rem; }
    .pill { display: inline-block; padding: 2px 10px; border-radius: 999px; border: 1px solid #ddd; }
    .dice { font-size: 1.2rem; letter-spacing: 2px; }
  </style>
</head>
<body>
  <h2>Mentiroso ðŸŽ² (1 = comodÃ­n)</h2>
  <div class="card">
    <label>Room ID: <input id="room" placeholder="p.ej. PARTIDA123" /></label>
    <button id="join">Unirse</button>
    <div id="connected" class="muted"></div>
  </div>

  <div id="ui" style="display:none">
    <div class="card">
      <div id="info"></div>
      <div class="muted">Reglas: Cada puja sube el <b>conteo +1</b> y eliges cara. Si alguien puja <b>unos</b>, se bloquea a <b>solo unos</b> hasta levantar.</div>
    </div>
    <div class="card">
      <div><b>Tus dados</b></div>
      <div id="dice" class="dice">-</div>
    </div>
    <div class="card">
      <div><b>Acciones</b></div>
      <div class="row" id="actions"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const socket = io(); // mismo origen
    let seat = null, state = null, myDice = [], roomId = qs.get("room") || "";

    const el = (id) => document.getElementById(id);
    el("room").value = roomId;
    el("join").onclick = ()=> {
      roomId = el("room").value.trim();
      if(!roomId){ alert("Introduce un Room ID"); return; }
      socket.emit("join",{roomId});
    };

    function render(){
      if(!state) return;
      el("ui").style.display = "block";
      const bidTxt = state.bid.count ? `${state.bid.count} de ${state.bid.face}` : "â€”";
      const waiting = state.waiting ? "Esperando rival..." : "";
      el("connected").innerText = waiting;
      el("info").innerHTML = `
        <div class="row">
          <div class="pill">Tu asiento: ${seat}</div>
          <div class="pill">Turno: ${state.turn}</div>
          <div class="pill">Vidas: ${state.lives?.[0]} - ${state.lives?.[1]}</div>
          <div class="pill">Puja: ${bidTxt}</div>
          <div class="pill">Solo unos: ${state.onesLock ? "sÃ­" : "no"}</div>
        </div>`;
      el("dice").innerText = myDice.length ? `[ ${myDice.join(", ")} ]` : "-";

      const myTurn = state.turn === seat && !state.waiting;
      const actions = el("actions");
      actions.innerHTML = "";

      if(!myTurn) return;

      if(state.bid.count > 0){
        const callBtn = document.createElement("button");
        callBtn.innerText = "LEVANTAR";
        callBtn.onclick = ()=> socket.emit("call",{roomId});
        actions.appendChild(callBtn);
      }
      const faces = state.onesLock ? [1] : [1,2,3,4,5,6];
      faces.forEach(f=>{
        const b = document.createElement("button");
        const nextCount = state.bid.count ? state.bid.count+1 : 1;
        b.innerText = `Subir a ${nextCount} de ${f}`;
        b.onclick = ()=> socket.emit("bid",{roomId, face:f});
        actions.appendChild(b);
      });
    }

    // Auto-unirse si viene por ?room=...
    if(roomId){ socket.emit("join",{roomId}); }

    socket.on("joined", p=> { seat = p.seat; el("connected").innerText = "Conectado. Esperando rival si aÃºn no hay dos."; });
    socket.on("yourDice", d=> { myDice = d; render(); });
    socket.on("state", s=> { state = s; render(); });
    socket.on("reveal", r=> {
      alert(`SE REVELA: \nJ0: [${r.dice[0]}]\nJ1: [${r.dice[1]}]\nTotal de ${r.bid.face} = ${r.total}\n${r.truth ? "La puja era VERDAD" : "La puja era MENTIRA"}`);
    });
    socket.on("gameover", g=> { alert(`Fin de partida.\nVidas: ${g.lives[0]} - ${g.lives[1]}`); });
    socket.on("error", e=> { alert(e); });
  </script>
</body>
</html>